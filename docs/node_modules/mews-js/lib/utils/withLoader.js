'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = withLoaderFactory;

var _semaphore = require('./semaphore');

var _semaphore2 = _interopRequireDefault(_semaphore);

var _noop = require('lodash/noop');

var _noop2 = _interopRequireDefault(_noop);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var HIDE_LOADER_TIMEOUT = 100;

function withLoaderFactory() {
    var showLoader = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : _noop2.default;
    var hideLoader = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : _noop2.default;

    var taskCounter = (0, _semaphore2.default)();
    taskCounter.onTake(showLoader);
    taskCounter.onLeave(hideLoader);

    return function withLoader(promise) {
        return Promise.resolve().then(function () {
            taskCounter.take();
            return promise();
        }).then(function (data) {
            delayedLeave();
            return data;
        }).catch(function (err) {
            delayedLeave();
            throw err;
        });
    };

    function delayedLeave() {
        setTimeout(taskCounter.leave, HIDE_LOADER_TIMEOUT);
    }
}