import _ from 'lodash';
import { type } from '../../../utils';
import { DataComponent } from '../data';
import Currency from './currency';

export default function CurrencyComponent(dataComponent) {
    type.check(dataComponent, DataComponent);

    const currencies = {};

    return type.create(CurrencyComponent, {
        getByCode(code) {
            if (!currencies[code]) {
                const currencyData = _.find(dataComponent.getCurrencies(), c => c.code === code);

                if (!currencyData) {
                    throw new Error(`Unknown currency: "${code}"`);
                }

                currencies[code] = Currency(currencyData);
            }

            return currencies[code] || null;
        },

        getAll() {
            const currenciesData = dataComponent.getCurrencies();
            if (_.size(currencies) !== _.size(currenciesData)) {
                const missingCurrenciesData = _.reject(currenciesData, c => currencies[c.code]);
                _.each(missingCurrenciesData, c => (currencies[c.code] = Currency(c)));
            }

            return currencies;
        },
    });
}
