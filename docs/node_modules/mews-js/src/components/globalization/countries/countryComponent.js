import _ from 'lodash';
import { type } from '../../../utils';
import { DataComponent } from '../data';
import Country from './country';

export default function CountryComponent(dataComponent) {
    type.check(dataComponent, DataComponent);

    const countries = {};

    return type.create(CountryComponent, {
        getByCode(code) {
            if (!countries[code]) {
                const countryData = _.find(dataComponent.getCountries(), c => c.code === code);

                if (!countryData) {
                    throw new Error(`Unknown country: "${code}"`);
                }

                countries[code] = Country(countryData);
            }

            return countries[code] || null;
        },

        getAll() {
            const countriesData = dataComponent.getCountries();
            if (_.size(countries) !== _.size(countriesData)) {
                const missingCountriesData = _.reject(countriesData, c => countries[c.code]);
                _.each(missingCountriesData, c => (countries[c.code] = Country(c)));
            }

            return countries;
        },
    });
}
