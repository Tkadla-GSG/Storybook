import React, { Component } from 'react';
import { PropTypes as pt } from 'prop-types';

import { noop } from '../utils/func';
import IconButton from '../Button/IconButton';
import Menu from '../Menu/Menu';
import ClickAway from '../ClickAway/ClickAway';
import { IconMenuElement } from './style';

class IconMenu extends Component {
    static propTypes = {
        deregisterClickAway: pt.func,
        icon: pt.string,
        innerRef: pt.func,
        children: pt.node,
        onItemSelected: pt.func,
        onChange: pt.func,
        registerClickAway: pt.func,
    };

    static defaultProps = {
        onItemSelected: noop,
        onChange: noop,
    };

    state = {};

    handleClick = () => {
        if (!this.state.opened) {
            this.props.registerClickAway();
            this.setState({ opened: true });
        }
    };

    // IconMenu does not support multiselect
    handleChange = items => this.props.onChange(items[0]);

    handleItemClick = item => {
        this.close();
        this.props.onItemSelected(item);
    };

    handleClickAway = () => this.close();

    close() {
        if (this.state.opened) {
            this.props.deregisterClickAway();
            this.setState({ opened: false });
        }
    }

    render() {
        const { icon, children, innerRef, ...other } = this.props;
        const { opened } = this.state;

        const iconMenuProps = {
            innerRef,
        };

        const buttonProps = {
            icon,
            onClick: this.handleClick,
            innerRef: c => (this.icon = c),
        };

        const menuProps = {
            ...other,
            anchorElement: () => this.icon,
            onItemClick: this.handleItemClick,
            onChange: this.handleChange,
            opened,
        };

        return (
            <IconMenuElement {...iconMenuProps}>
                <IconButton {...buttonProps} />
                <Menu {...menuProps}>
                    {children}
                </Menu>
            </IconMenuElement>
        );
    }
}

export default ClickAway(IconMenu);
